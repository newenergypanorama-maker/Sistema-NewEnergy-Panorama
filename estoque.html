<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Estoque | Panorama Health</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .tabs { display: flex; gap: 5px; margin-bottom: 20px; background: #f1f5f9; padding: 5px; border-radius: 12px; }
        .tabs button { margin: 0; background: transparent; font-size: 13px; padding: 10px; }
        .tabs button.active { background: white; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .section { display: none; }
        .section.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
<header>
    <h1>Gestão de Materiais</h1>
    <button onclick="window.location.href='painel.html'" style="width: auto; padding: 5px 15px; margin:0">Voltar</button>
</header>

<div class="main">
    <div class="container" style="max-width: 800px;">
        <div class="tabs">
            <button onclick="mostrar('cadastro',this)" class="active">Novo Produto</button>
            <button onclick="mostrar('mov',this)">Movimentação</button>
            <button onclick="mostrar('atual',this)">Estoque Atual</button>
            <button onclick="mostrar('minimo',this)">Alertas</button>
        </div>

        <div id="cadastro" class="section active">
            <h2>Cadastrar Material</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <input type="text" id="pn" placeholder="Part Number">
                <input type="text" id="name" placeholder="Nome do Item">
                <input type="text" id="fab" placeholder="Fabricante">
                <input type="number" id="min" placeholder="Qtd Mínima">
            </div>
            <button class="primary" onclick="cadastrar()">Salvar Produto</button>
        </div>

        <div id="mov" class="section">
            <h2>Entrada / Saída</h2>
            <input list="produtosList" id="movPN" placeholder="Part Number">
            <datalist id="produtosList"></datalist>
            <input type="number" id="movQtd" placeholder="Quantidade">
            <select id="tipo">
                <option value="entrada">Entrada (+)</option>
                <option value="saida">Saída (-)</option>
            </select>
            <button class="primary" onclick="movimentar()">Registrar</button>
        </div>

        <div id="atual" class="section">
            <h2>Saldo em Estoque</h2>
            <table>
                <thead><tr><th>PN</th><th>Nome</th><th>Saldo</th></tr></thead>
                <tbody id="tabEstoque"></tbody>
            </table>
        </div>

        <div id="minimo" class="section">
            <h2>Alertas de Reposição</h2>
            <div id="alertasContainer"></div>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, serverTimestamp, query, where } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyDvmATRrkhu-rJFpr2Ql_gYhIBK7sqdssQ",
    authDomain: "sistema-newenergy-panora-24697.firebaseapp.com",
    projectId: "sistema-newenergy-panora-24697",
    storageBucket: "sistema-newenergy-panora-24697.firebasestorage.app",
    messagingSenderId: "503251309234",
    appId: "1:503251309234:web:8f4d905e5e4b1f496befab"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Navegação entre abas
window.mostrar = (id, btn) => {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.tabs button').forEach(b => b.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    btn.classList.add('active');
    if(id === 'atual') carregarSaldo();
    if(id === 'minimo') verificarMinimo();
};

// Cadastrar Produto
window.cadastrar = async () => {
    const pn = document.getElementById('pn').value;
    const name = document.getElementById('name').value;
    if(!pn || !name) return alert("Preencha PN e Nome");
    
    try {
        await addDoc(collection(db, "produtos"), {
            pn, name, fab: document.getElementById('fab').value,
            min: parseInt(document.getElementById('min').value) || 0,
            criadoEm: serverTimestamp()
        });
        alert("Produto salvo!");
        location.reload();
    } catch(e) { alert("Erro: " + e.message); }
};

// Carregar lista para o autocomplete
const carregarLista = async () => {
    const snap = await getDocs(collection(db, "produtos"));
    const list = document.getElementById('produtosList');
    snap.forEach(doc => {
        const opt = document.createElement('option');
        opt.value = doc.data().pn;
        list.appendChild(opt);
    });
};
carregarLista();

// Registrar Movimentação
window.movimentar = async () => {
    const pn = document.getElementById('movPN').value;
    const qtd = parseInt(document.getElementById('movQtd').value);
    if(!pn || !qtd) return alert("Preencha os campos");

    await addDoc(collection(db, "movimentacoes"), {
        pn, qtd, tipo: document.getElementById('tipo').value,
        data: serverTimestamp()
    });
    alert("Registrado!");
    document.getElementById('movQtd').value = "";
};

// Calcular Saldo Atual
async function calcularSaldos() {
    const movs = await getDocs(collection(db, "movimentacoes"));
    const produtos = await getDocs(collection(db, "produtos"));
    let saldos = {};
    
    produtos.forEach(p => {
        saldos[p.data().pn] = { nome: p.data().name, min: p.data().min, total: 0 };
    });

    movs.forEach(m => {
        const d = m.data();
        if(saldos[d.pn]) {
            saldos[d.pn].total += (d.tipo === 'entrada' ? d.qtd : -d.qtd);
        }
    });
    return saldos;
}

window.carregarSaldo = async () => {
    const tab = document.getElementById('tabEstoque');
    tab.innerHTML = "Carregando...";
    const saldos = await calcularSaldos();
    tab.innerHTML = "";
    for(let pn in saldos) {
        tab.innerHTML += `<tr><td>${pn}</td><td>${saldos[pn].nome}</td><td><b>${saldos[pn].total}</b></td></tr>`;
    }
};

window.verificarMinimo = async () => {
    const cont = document.getElementById('alertasContainer');
    cont.innerHTML = "Verificando...";
    const saldos = await calcularSaldos();
    cont.innerHTML = "";
    for(let pn in saldos) {
        if(saldos[pn].total <= saldos[pn].min) {
            cont.innerHTML += `<div class="alerta">⚠️ <b>${saldos[pn].nome}</b> está abaixo do mínimo! (Saldo: ${saldos[pn].total})</div>`;
        }
    }
};
</script>
</body>
</html>
