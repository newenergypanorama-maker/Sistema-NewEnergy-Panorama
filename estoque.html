<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Gestão Profissional de Estoque</title>
<link rel="stylesheet" href="style.css">

<style>
/* MENU ABAS PROFISSIONAL */
.tabs{
  display:flex;
  border-bottom:2px solid #E5E7EB;
  margin-bottom:20px;
}
.tabs button{
  background:none;
  border:none;
  padding:14px 20px;
  cursor:pointer;
  font-weight:600;
  border-bottom:3px solid transparent;
}
.tabs button.active{
  border-bottom:3px solid #2563EB;
  color:#2563EB;
}
.section{ display:none; }
.section.active{ display:block; }

.alerta{
  background:#FEE2E2;
  padding:10px;
  margin-bottom:10px;
  border-radius:6px;
  color:#991B1B;
}
</style>
</head>

<body>

<header>
  <img src="logo.png" class="logo">
  <h1>Gestão Avançada de Estoque</h1>
</header>

<div class="main">
<div class="container" style="max-width:1000px">

<div class="tabs">
  <button onclick="mostrar('cadastro',this)" class="active">Cadastro Produto</button>
  <button onclick="mostrar('mov',this)">Movimentação</button>
  <button onclick="mostrar('atual',this)">Estoque Atual</button>
  <button onclick="mostrar('minimo',this)">Estoque Mínimo</button>
</div>

<!-- CADASTRO -->
<div id="cadastro" class="section active">
<h2>Novo Produto</h2>

<input type="text" id="pn" placeholder="Part Number">
<input type="text" id="name" placeholder="Part Name">
<input type="text" id="fabricante" placeholder="Fabricante">
<input type="text" id="sn" placeholder="Serial Number (SN)">
<input type="number" id="min" placeholder="Estoque Mínimo">

<button class="primary" onclick="cadastrarProduto()">Cadastrar Produto</button>
</div>

<!-- MOVIMENTAÇÃO -->
<div id="mov" class="section">
<h2>Movimentação</h2>

<input list="listaProdutos" id="movPN" placeholder="Part Number">
<datalist id="listaProdutos"></datalist>

<input type="text" id="movName" placeholder="Part Name (auto)">
<input type="number" id="movQtd" placeholder="Quantidade">
<input type="text" id="origem" placeholder="Origem">
<input type="text" id="destino" placeholder="Destino">
<input type="text" id="cliente" placeholder="Cliente">
<input type="text" id="os" placeholder="Ordem de Serviço (OS)">

<select id="tipo">
<option value="entrada">Entrada</option>
<option value="saida">Saída</option>
</select>

<button class="primary" onclick="registrarMov()">Registrar Movimentação</button>
</div>

<!-- ESTOQUE ATUAL -->
<div id="atual" class="section">
<h2>Estoque Atual Consolidado</h2>
<table id="tabelaAtual">
<thead>
<tr>
<th>Part Number</th>
<th>Part Name</th>
<th>Saldo</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<!-- ESTOQUE MINIMO -->
<div id="minimo" class="section">
<h2>Produtos Abaixo do Mínimo</h2>
<div id="alertas"></div>
</div>

<button class="primary" onclick="window.location.href='painel.html'">
Voltar ao Painel
</button>

</div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDvmATRrkhu-rJFpr2Ql_gYhIBK7sqdssQ",
  authDomain: "sistema-newenergy-panora-24697.firebaseapp.com",
  projectId: "sistema-newenergy-panora-24697",
  storageBucket: "sistema-newenergy-panora-24697.firebasestorage.app",
  messagingSenderId: "503251309234",
  appId: "1:503251309234:web:8f4d905e5e4b1f496befab"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

onAuthStateChanged(auth, user=>{
 if(!user) window.location.href="login.html";
});

/* TABS */
window.mostrar = function(sec,btn){
 document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
 document.querySelectorAll('.tabs button').forEach(b=>b.classList.remove('active'));
 document.getElementById(sec).classList.add('active');
 btn.classList.add('active');
 if(sec==="atual") carregarEstoque();
 if(sec==="minimo") verificarMinimo();
}

/* CARREGAR PRODUTOS PARA AUTOCOMPLETE */
async function carregarProdutos(){
 const snap=await getDocs(collection(db,"produtos"));
 const lista=document.getElementById("listaProdutos");
 lista.innerHTML="";
 snap.forEach(doc=>{
  const p=doc.data();
  const option=document.createElement("option");
  option.value=p.partNumber;
  lista.appendChild(option);
 });
}
carregarProdutos();

/* AUTO PREENCHER PART NAME */
document.getElementById("movPN").addEventListener("change",async e=>{
 const pn=e.target.value;
 const snap=await getDocs(collection(db,"produtos"));
 snap.forEach(doc=>{
  const p=doc.data();
  if(p.partNumber===pn){
   document.getElementById("movName").value=p.partName;
  }
 });
});

/* CADASTRAR PRODUTO */
window.cadastrarProduto=async function(){
 await addDoc(collection(db,"produtos"),{
  partNumber:pn.value,
  partName:name.value,
  fabricante:fabricante.value,
  serialNumber:sn.value,
  estoqueMinimo:parseInt(min.value),
  createdAt:serverTimestamp()
 });
 alert("Produto cadastrado!");
 carregarProdutos();
}

/* REGISTRAR MOVIMENTAÇÃO */
window.registrarMov=async function(){

 let saldo=0;
 const movSnap=await getDocs(collection(db,"movimentacoes"));
 movSnap.forEach(doc=>{
  const d=doc.data();
  if(d.partNumber===movPN.value){
   if(d.tipo==="entrada") saldo+=d.quantidade;
   if(d.tipo==="saida") saldo-=d.quantidade;
  }
 });

 if(tipo.value==="saida" && movQtd.value>saldo){
  alert("Saldo insuficiente!");
  return;
 }

 const novoSaldo = tipo.value==="entrada" ? saldo+parseInt(movQtd.value) : saldo-parseInt(movQtd.value);

 await addDoc(collection(db,"movimentacoes"),{
  partNumber:movPN.value,
  partName:movName.value,
  quantidade:parseInt(movQtd.value),
  origem:origem.value,
  destino:destino.value,
  cliente:cliente.value,
  OS:os.value,
  tipo:tipo.value,
  saldo:novoSaldo,
  createdAt:serverTimestamp()
 });

 alert("Movimentação registrada!");
}

/* ESTOQUE ATUAL */
async function carregarEstoque(){
 const tabela=document.querySelector("#tabelaAtual tbody");
 tabela.innerHTML="";
 const snap=await getDocs(collection(db,"movimentacoes"));
 const mapa={};
 snap.forEach(doc=>{
  const d=doc.data();
  if(!mapa[d.partNumber]) mapa[d.partNumber]={name:d.partName,saldo:0};
  if(d.tipo==="entrada") mapa[d.partNumber].saldo+=d.quantidade;
  if(d.tipo==="saida") mapa[d.partNumber].saldo-=d.quantidade;
 });
 for(const pn in mapa){
  const tr=document.createElement("tr");
  tr.innerHTML=`<td>${pn}</td><td>${mapa[pn].name}</td><td>${mapa[pn].saldo}</td>`;
  tabela.appendChild(tr);
 }
}

/* ESTOQUE MINIMO */
async function verificarMinimo(){
 const div=document.getElementById("alertas");
 div.innerHTML="";
 const produtos=await getDocs(collection(db,"produtos"));
 const mov=await getDocs(collection(db,"movimentacoes"));

 const saldo={};

 mov.forEach(doc=>{
  const d=doc.data();
  if(!saldo[d.partNumber]) saldo[d.partNumber]=0;
  if(d.tipo==="entrada") saldo[d.partNumber]+=d.quantidade;
  if(d.tipo==="saida") saldo[d.partNumber]-=d.quantidade;
 });

 produtos.forEach(doc=>{
  const p=doc.data();
  const atual=saldo[p.partNumber]||0;
  if(atual<=p.estoqueMinimo){
   const alerta=document.createElement("div");
   alerta.className="alerta";
   alerta.innerHTML=`${p.partName} (${p.partNumber}) abaixo do mínimo. Saldo: ${atual}`;
   div.appendChild(alerta);
  }
 });
}

</script>

</body>
</html>
