<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Stock Enterprise | Panorama Health</title>
</head>
<body>

<header>
    <div style="font-weight: 800; letter-spacing: -1px; font-size: 1.4rem;">
        PANORAMA <span style="color: var(--primary);">HEALTH</span>
    </div>
    <div style="display: flex; gap: 10px;">
        <button class="btn" style="background: var(--bg); color: var(--text);" onclick="window.location.href='painel.html'">PAINEL</button>
    </div>
</header>

<div class="container">
    <div class="stats-grid">
        <div class="stat-card"><h3>Itens Totais</h3><p id="dashTotal">0</p></div>
        <div class="stat-card"><h3>Alertas de Stock</h3><p id="dashAlert" style="color: var(--danger);">0</p></div>
        <div class="stat-card"><h3>Validade (30 dias)</h3><p id="dashVenc" style="color: var(--warning);">0</p></div>
    </div>

    <div class="tabs">
        <button onclick="aba(event, 'est')" class="active">üìä STOCK ATUAL</button>
        <button onclick="aba(event, 'cad')">‚ûï CADASTRAR ITEM</button>
        <button onclick="aba(event, 'mov')">üîÑ MOVIMENTA√á√ÉO</button>
        <button onclick="aba(event, 'his')">üìú HIST√ìRICO</button>
    </div>

    <div id="est" class="section active">
        <div style="display: flex; gap: 10px; margin-bottom: 1.5rem;">
            <input type="text" id="filtroEstoque" placeholder="üîç Procurar por PN ou Nome..." onkeyup="renderEstoque()">
            <button class="btn" style="background: var(--success); color:white" onclick="exportarCSV()">EXPORTAR</button>
        </div>
        <div style="overflow-x: auto;">
            <table>
                <thead>
                    <tr>
                        <th>Part Number</th>
                        <th>Nome do Item</th>
                        <th>Categoria</th>
                        <th>Saldo</th>
                        <th>Validade</th>
                        <th>Local</th>
                    </tr>
                </thead>
                <tbody id="tabEst"></tbody>
            </table>
        </div>
    </div>

    <div id="cad" class="section">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
            <div><label>Part Number</label><input type="text" id="pn"></div>
            <div><label>Nome do Produto</label><input type="text" id="name"></div>
            <div>
                <label>Categoria</label>
                <select id="cat">
                    <option value="Reagentes">Reagentes</option>
                    <option value="Consum√≠veis">Consum√≠veis</option>
                    <option value="Hardware">Hardware</option>
                </select>
            </div>
            <div><label>Stock M√≠nimo</label><input type="number" id="min" value="5"></div>
            <div><label>Localiza√ß√£o (Rua/Prateleira)</label><input type="text" id="local"></div>
            <div><label>Data de Validade</label><input type="date" id="val"></div>
        </div>
        <button class="btn btn-primary" style="margin-top: 2rem;" onclick="cadastrar()">GUARDAR NOVO ITEM</button>
    </div>

    <div id="mov" class="section">
        <div style="max-width: 500px; margin: 0 auto;">
            <label>Seleccionar Item (PN)</label>
            <input list="lPN" id="mPN" placeholder="Procure o c√≥digo...">
            <datalist id="lPN"></datalist>
            
            <label style="display:block; margin-top: 1rem;">Quantidade</label>
            <input type="number" id="mQtd">

            <label style="display:block; margin-top: 1rem;">Tipo de Opera√ß√£o</label>
            <select id="mTipo">
                <option value="entrada">ENTRADA (+)</option>
                <option value="saida">SA√çDA (-)</option>
            </select>

            <button class="btn btn-primary" style="margin-top: 2rem;" onclick="movimentar()">REGISTAR OPERA√á√ÉO</button>
        </div>
    </div>

    <div id="his" class="section">
        <table>
            <thead><tr><th>Data/Hora</th><th>Item</th><th>Tipo</th><th>Qtd</th><th>Operador</th></tr></thead>
            <tbody id="tabHis"></tbody>
        </table>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDvmATRrkhu-rJFpr2Ql_gYhIBK7sqdssQ",
        authDomain: "sistema-newenergy-panora-24697.firebaseapp.com",
        projectId: "sistema-newenergy-panora-24697",
        storageBucket: "sistema-newenergy-panora-24697.firebasestorage.app",
        messagingSenderId: "503251309234",
        appId: "1:503251309234:web:8f4d905e5e4b1f496befab"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    let uEmail = ""; let pCache = [];

    onAuthStateChanged(auth, user => {
        if (user) { uEmail = user.email; loadBase(); }
        else window.location.href = "login.html";
    });

    window.aba = (e, n) => {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.tabs button').forEach(b => b.classList.remove('active'));
        document.getElementById(n).classList.add('active');
        e.currentTarget.classList.add('active');
        if(n === 'est') renderEstoque();
        if(n === 'his') renderHistorico();
    };

    async function loadBase() {
        const snap = await getDocs(collection(db, "produtos"));
        pCache = [];
        const dl = document.getElementById('lPN'); dl.innerHTML = "";
        snap.forEach(doc => { 
            const d = doc.data(); 
            pCache.push(d);
            dl.innerHTML += `<option value="${d.pn}">${d.name}</option>`;
        });
        renderEstoque();
    }

    window.cadastrar = async () => {
        const item = {
            pn: document.getElementById('pn').value,
            name: document.getElementById('name').value,
            cat: document.getElementById('cat').value,
            min: parseInt(document.getElementById('min').value),
            local: document.getElementById('local').value,
            val: document.getElementById('val').value,
            responsavel: uEmail,
            data: serverTimestamp()
        };
        await addDoc(collection(db, "produtos"), item);
        alert("Sucesso: Item guardado!");
        location.reload();
    };

    window.movimentar = async () => {
        const mov = {
            pn: document.getElementById('mPN').value,
            qtd: parseInt(document.getElementById('mQtd').value),
            tipo: document.getElementById('mTipo').value,
            responsavel: uEmail,
            data: serverTimestamp()
        };
        await addDoc(collection(db, "movimentacoes"), mov);
        alert("Sucesso: Stock atualizado!");
        location.reload();
    };

    window.renderEstoque = async () => {
        const mS = await getDocs(collection(db, "movimentacoes"));
        let saldos = {};
        pCache.forEach(p => saldos[p.pn] = { ...p, total: 0 });
        mS.forEach(m => {
            const d = m.data();
            if(saldos[d.pn]) saldos[d.pn].total += (d.tipo === 'entrada' ? d.qtd : -d.qtd);
        });

        const out = document.getElementById('tabEst');
        const filtro = document.getElementById('filtroEstoque').value.toLowerCase();
        out.innerHTML = "";
        
        let cAlert = 0; let cVenc = 0;
        const hoje = new Date();
        const limiteVenc = new Date(); limiteVenc.setDate(hoje.getDate() + 30);

        for(let k in saldos) {
            const i = saldos[k];
            if(!i.pn.toLowerCase().includes(filtro) && !i.name.toLowerCase().includes(filtro)) continue;

            const dVal = i.val ? new Date(i.val) : null;
            if(i.total <= i.min) cAlert++;
            if(dVal && dVal <= limiteVenc) cVenc++;

            out.innerHTML += `
                <tr>
                    <td><b>${i.pn}</b></td>
                    <td>${i.name}</td>
                    <td><span class="badge" style="background:#f1f5f9">${i.cat}</span></td>
                    <td><span class="badge ${i.total <= i.min ? 'badge-low' : 'badge-ok'}">${i.total}</span></td>
                    <td style="color:${dVal && dVal <= limiteVenc ? 'var(--danger)' : 'inherit'}">
                        ${i.val ? dVal.toLocaleDateString() : 'N/A'}
                    </td>
                    <td>${i.local}</td>
                </tr>`;
        }
        document.getElementById('dashTotal').innerText = pCache.length;
        document.getElementById('dashAlert').innerText = cAlert;
        document.getElementById('dashVenc').innerText = cVenc;
    };

    window.exportarCSV = () => {
        let content = "Part Number;Nome;Saldo;Validade;Local\n";
        pCache.forEach(i => content += `${i.pn};${i.name};${i.total || 0};${i.val};${i.local}\n`);
        const blob = new Blob([content], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'stock_panorama.csv';
        a.click();
    };

    window.renderHistorico = async () => {
        const snap = await getDocs(query(collection(db, "movimentacoes"), orderBy("data", "desc")));
        const out = document.getElementById('tabHis'); out.innerHTML = "";
        snap.forEach(doc => {
            const d = doc.data();
            out.innerHTML += `<tr>
                <td style="color:var(--text-muted)">${d.data?.toDate().toLocaleString()}</td>
                <td><b>${d.pn}</b></td>
                <td style="color:${d.tipo === 'entrada' ? 'var(--success)' : 'var(--danger)'}">${d.tipo.toUpperCase()}</td>
                <td>${d.qtd}</td>
                <td>${d.responsavel.split('@')[0]}</td>
            </tr>`;
        });
    };
</script>
</body>
</html>
