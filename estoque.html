<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Gest칚o Pro | Panorama Health</title>
</head>
<body>

<header>
    <div style="font-weight: 800; font-size: 1.2rem;">PANORAMA <span style="color: var(--primary);">HEALTH</span></div>
    <button class="btn btn-outline" onclick="window.location.href='painel.html'">Sair</button>
</header>

<div class="container">
    <div class="stats-grid">
        <div class="stat-card"><h3>Total Itens</h3><p id="statTotal">0</p></div>
        <div class="stat-card"><h3>Estoque Baixo</h3><p id="statAlert" style="color: var(--danger);">0</p></div>
        <div class="stat-card"><h3>Vencendo (30d)</h3><p id="statVenc" style="color: var(--warning);">0</p></div>
    </div>

    <div class="tabs">
        <button onclick="aba(event, 'est')" class="active">ESTOQUE ATUAL</button>
        <button onclick="aba(event, 'cad')">NOVO ITEM</button>
        <button onclick="aba(event, 'mov')">MOVIMENTAR</button>
        <button onclick="aba(event, 'his')">HIST칍RICO</button>
    </div>

    <div id="est" class="section active">
        <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
            <input type="text" id="buscaEstoque" placeholder="游댌 Filtrar estoque..." onkeyup="renderEstoque()" style="width: 70%;">
            <button class="btn btn-outline" onclick="exportarCSV()">游닌 Exportar</button>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Part Number</th>
                    <th>Descri칞칚o</th>
                    <th>Categoria</th>
                    <th>Saldo</th>
                    <th>Validade</th>
                    <th>Local</th>
                </tr>
            </thead>
            <tbody id="tabEst"></tbody>
        </table>
    </div>

    <div id="cad" class="section">
        <div class="form-grid">
            <div class="input-group"><label>PN (Part Number)</label><input type="text" id="pn"></div>
            <div class="input-group"><label>Nome do Item</label><input type="text" id="name"></div>
            <div class="input-group">
                <label>Categoria</label>
                <select id="cat">
                    <option value="Insumos">Insumos</option>
                    <option value="Equipamentos">Equipamentos</option>
                    <option value="Escrit칩rio">Escrit칩rio</option>
                </select>
            </div>
            <div class="input-group"><label>Estoque M칤nimo</label><input type="number" id="min" value="5"></div>
            <div class="input-group"><label>Localiza칞칚o</label><input type="text" id="local"></div>
            <div class="input-group"><label>Validade (se houver)</label><input type="date" id="val"></div>
        </div>
        <button class="btn btn-primary" onclick="cadastrar()">SALVAR ITEM</button>
    </div>

    <div id="mov" class="section">
        <div class="form-grid">
            <div class="input-group"><label>Item (PN)</label><input list="lPN" id="mPN" onchange="sync(this.value)"></div>
            <div class="input-group"><label>Quantidade</label><input type="number" id="mQtd"></div>
            <div class="input-group">
                <label>Opera칞칚o</label>
                <select id="mTipo">
                    <option value="entrada">ENTRADA (+)</option>
                    <option value="saida">SA칈DA (-)</option>
                </select>
            </div>
            <datalist id="lPN"></datalist>
        </div>
        <button class="btn btn-primary" onclick="movimentar()">CONFIRMAR MOVIMENTA칂츾O</button>
    </div>

    <div id="his" class="section">
        <table>
            <thead><tr><th>Data</th><th>Item</th><th>Tipo</th><th>Qtd</th><th>Usu치rio</th></tr></thead>
            <tbody id="tabHis"></tbody>
        </table>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDvmATRrkhu-rJFpr2Ql_gYhIBK7sqdssQ",
        authDomain: "sistema-newenergy-panora-24697.firebaseapp.com",
        projectId: "sistema-newenergy-panora-24697",
        storageBucket: "sistema-newenergy-panora-24697.firebasestorage.app",
        messagingSenderId: "503251309234",
        appId: "1:503251309234:web:8f4d905e5e4b1f496befab"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    let uEmail = ""; let pCache = [];

    onAuthStateChanged(auth, user => {
        if (user) { uEmail = user.email; loadBase(); }
        else window.location.href = "login.html";
    });

    window.aba = (e, n) => {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.tabs button').forEach(b => b.classList.remove('active'));
        document.getElementById(n).classList.add('active');
        e.currentTarget.classList.add('active');
        if(n === 'est') renderEstoque();
        if(n === 'his') renderHistorico();
    };

    async function loadBase() {
        const snap = await getDocs(collection(db, "produtos"));
        pCache = [];
        const dl = document.getElementById('lPN'); dl.innerHTML = "";
        snap.forEach(doc => { 
            const d = doc.data(); 
            pCache.push(d);
            dl.innerHTML += `<option value="${d.pn}">${d.name}</option>`;
        });
        renderEstoque();
    }

    window.cadastrar = async () => {
        const item = {
            pn: document.getElementById('pn').value,
            name: document.getElementById('name').value,
            cat: document.getElementById('cat').value,
            min: parseInt(document.getElementById('min').value),
            local: document.getElementById('local').value,
            val: document.getElementById('val').value,
            responsavel: uEmail,
            data: serverTimestamp()
        };
        await addDoc(collection(db, "produtos"), item);
        alert("Item cadastrado com sucesso!");
        location.reload();
    };

    window.movimentar = async () => {
        const mov = {
            pn: document.getElementById('mPN').value,
            qtd: parseInt(document.getElementById('mQtd').value),
            tipo: document.getElementById('mTipo').value,
            responsavel: uEmail,
            data: serverTimestamp()
        };
        await addDoc(collection(db, "movimentacoes"), mov);
        alert("Movimenta칞칚o registrada!");
        location.reload();
    };

    window.renderEstoque = async () => {
        const mS = await getDocs(collection(db, "movimentacoes"));
        let saldos = {};
        pCache.forEach(p => saldos[p.pn] = { ...p, total: 0 });
        mS.forEach(m => {
            const data = m.data();
            if(saldos[data.pn]) saldos[data.pn].total += (data.tipo === 'entrada' ? data.qtd : -data.qtd);
        });

        const out = document.getElementById('tabEst');
        out.innerHTML = "";
        let countAlert = 0; let countVenc = 0;
        const hoje = new Date();
        const trintaDias = new Date(); trintaDias.setDate(hoje.getDate() + 30);

        for(let k in saldos) {
            const item = saldos[k];
            const dataVal = item.val ? new Date(item.val) : null;
            
            // L칩gica de Alertas
            if(item.total <= item.min) countAlert++;
            if(dataVal && dataVal <= trintaDias) countVenc++;

            out.innerHTML += `
                <tr>
                    <td><b>${item.pn}</b></td>
                    <td>${item.name}</td>
                    <td><span class="badge" style="background:#f1f5f9">${item.cat}</span></td>
                    <td><span class="badge ${item.total <= item.min ? 'badge-danger' : 'badge-success'}">${item.total}</span></td>
                    <td style="color: ${dataVal && dataVal <= trintaDias ? 'var(--danger)' : 'inherit'}">
                        ${item.val ? new Date(item.val).toLocaleDateString() : '-'}
                    </td>
                    <td>${item.local}</td>
                </tr>`;
        }
        document.getElementById('statTotal').innerText = pCache.length;
        document.getElementById('statAlert').innerText = countAlert;
        document.getElementById('statVenc').innerText = countVenc;
    };

    window.exportarCSV = () => {
        let csv = "PN,Item,Saldo,Local\n";
        document.querySelectorAll("#tabEst tr").forEach(tr => {
            const cols = tr.querySelectorAll("td");
            if(cols.length) csv += `${cols[0].innerText},${cols[1].innerText},${cols[3].innerText},${cols[5].innerText}\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.setAttribute('href', url);
        a.setAttribute('download', 'estoque_panorama.csv');
        a.click();
    };

    window.renderHistorico = async () => {
        const snap = await getDocs(query(collection(db, "movimentacoes"), orderBy("data", "desc")));
        const out = document.getElementById('tabHis'); out.innerHTML = "";
        snap.forEach(doc => {
            const d = doc.data();
            out.innerHTML += `<tr>
                <td>${d.data?.toDate().toLocaleDateString()}</td>
                <td>${d.pn}</td>
                <td style="color:${d.tipo === 'entrada' ? 'var(--success)' : 'var(--danger)'}">${d.tipo.toUpperCase()}</td>
                <td>${d.qtd}</td>
                <td>${d.responsavel.split('@')[0]}</td>
            </tr>`;
        });
    };
</script>
</body>
</html>
