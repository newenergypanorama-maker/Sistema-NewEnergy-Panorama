<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Estoque | Panorama</title>
</head>
<body>

<header>
    <div style="font-weight: 800; color: var(--primary); letter-spacing: -0.5px;">PANORAMA HEALTH</div>
    <div style="display: flex; align-items: center; gap: 15px;">
        <span id="uEmail" style="font-size: 12px; color: var(--text-muted); display: none; @media (min-width: 600px) { display: block; }">...</span>
        <button class="btn" style="padding: 6px 15px; background: #f1f5f9;" onclick="window.location.href='painel.html'">VOLTAR</button>
    </div>
</header>

<div class="container">
    <div class="tabs">
        <button onclick="aba(event, 'cad')" class="active">CADASTRO</button>
        <button onclick="aba(event, 'mov')">MOVIMENTA√á√ÉO</button>
        <button onclick="aba(event, 'est')">SALDOS</button>
        <button onclick="aba(event, 'his')">HIST√ìRICO</button>
        <button onclick="aba(event, 'ale')">ALERTAS</button>
    </div>

    <div id="cad" class="section active">
        <div class="table-area" style="padding: 20px; border: none;">
            <div class="form-grid">
                <div class="input-group"><label>Part Number</label><input type="text" id="pn" placeholder="Ex: PN123"></div>
                <div class="input-group"><label>Nome do Item</label><input type="text" id="name" placeholder="Descri√ß√£o do produto"></div>
                <div class="input-group"><label>Localiza√ß√£o</label><input type="text" id="local" placeholder="Ex: Prateleira A1"></div>
                <div class="input-group"><label>Estoque M√≠nimo</label><input type="number" id="min" value="2"></div>
            </div>
            <button class="btn btn-primary" onclick="cadastrar()">CADASTRAR ITEM</button>
        </div>
    </div>

    <div id="mov" class="section">
        <div class="table-area" style="padding: 20px; border: none;">
            <div class="form-grid">
                <div class="input-group"><label>Buscar PN</label><input list="lPN" id="mPN" onchange="sync(this.value, 'pn')" placeholder="Digite o PN"></div>
                <div class="input-group"><label>Buscar Nome</label><input list="lName" id="mName" onchange="sync(this.value, 'name')" placeholder="Digite o nome"></div>
                <div class="input-group"><label>Quantidade</label><input type="number" id="mQtd"></div>
                <div class="input-group">
                    <label>Tipo</label>
                    <select id="mTipo">
                        <option value="entrada">ENTRADA (+)</option>
                        <option value="saida">SA√çDA (-)</option>
                    </select>
                </div>
                <datalist id="lPN"></datalist><datalist id="lName"></datalist>
            </div>
            <button class="btn btn-primary" onclick="movimentar()">REGISTRAR MOVIMENTA√á√ÉO</button>
        </div>
    </div>

    <div id="est" class="section">
        <div class="table-area">
            <table>
                <thead><tr><th>PN</th><th>NOME</th><th>LOCAL</th><th>SALDO ATUAL</th></tr></thead>
                <tbody id="tabEst"></tbody>
            </table>
        </div>
    </div>

    <div id="his" class="section">
        <input type="text" id="fHist" placeholder="üîç Filtrar hist√≥rico por PN ou Nome..." onkeyup="filtrarHist()" style="margin-bottom: 15px;">
        <div class="table-area">
            <table>
                <thead><tr><th>DATA</th><th>ITEM</th><th>TIPO</th><th>QTD</th><th>OPERADOR</th></tr></thead>
                <tbody id="tabHis"></tbody>
            </table>
        </div>
    </div>

    <div id="ale" class="section">
        <div id="aleCont"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDvmATRrkhu-rJFpr2Ql_gYhIBK7sqdssQ",
        authDomain: "sistema-newenergy-panora-24697.firebaseapp.com",
        projectId: "sistema-newenergy-panora-24697",
        storageBucket: "sistema-newenergy-panora-24697.firebasestorage.app",
        messagingSenderId: "503251309234",
        appId: "1:503251309234:web:8f4d905e5e4b1f496befab"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let uEmail = ""; let pCache = [];

    onAuthStateChanged(auth, user => {
        if (user) { 
            uEmail = user.email; 
            document.getElementById('uEmail').innerText = user.email; 
            loadBase(); 
        } else {
            window.location.href = "login.html";
        }
    });

    window.aba = (e, n) => {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.tabs button').forEach(b => b.classList.remove('active'));
        document.getElementById(n).classList.add('active'); 
        e.currentTarget.classList.add('active');
        if(n === 'est') renderEstoque(); 
        if(n === 'his') renderHistorico(); 
        if(n === 'ale') renderAlertas();
    };

    window.sync = (v, t) => {
        const item = pCache.find(p => t === 'pn' ? p.pn === v : p.name === v);
        if(item) { 
            document.getElementById('mPN').value = item.pn; 
            document.getElementById('mName').value = item.name; 
        }
    };

    async function loadBase() {
        const snap = await getDocs(collection(db, "produtos"));
        pCache = []; 
        const dPN = document.getElementById('lPN'); 
        const dName = document.getElementById('lName');
        dPN.innerHTML = ""; dName.innerHTML = "";
        snap.forEach(doc => { 
            const d = doc.data(); 
            pCache.push(d); 
            dPN.innerHTML += `<option value="${d.pn}">`; 
            dName.innerHTML += `<option value="${d.name}">`; 
        });
    }

    window.cadastrar = async () => {
        const pn = document.getElementById('pn').value;
        if(!pn) return alert("Preencha o Part Number");
        await addDoc(collection(db, "produtos"), { 
            pn, 
            name: document.getElementById('name').value, 
            local: document.getElementById('local').value, 
            min: parseInt(document.getElementById('min').value), 
            responsavel: uEmail, 
            data: serverTimestamp() 
        });
        alert("Item cadastrado!");
        location.reload();
    };

    window.movimentar = async () => {
        const pn = document.getElementById('mPN').value;
        const qtd = parseInt(document.getElementById('mQtd').value);
        if(!pn || !qtd) return alert("Preencha PN e Quantidade");
        
        await addDoc(collection(db, "movimentacoes"), { 
            pn, 
            qtd, 
            tipo: document.getElementById('mTipo').value, 
            responsavel: uEmail, 
            data: serverTimestamp() 
        });
        alert("Movimenta√ß√£o registrada!");
        location.reload();
    };

    async function getSaldos() {
        const pS = await getDocs(collection(db, "produtos")); 
        const mS = await getDocs(collection(db, "movimentacoes"));
        let s = {};
        pS.forEach(d => { 
            const v = d.data(); 
            s[v.pn] = { nome: v.name, min: v.min, local: v.local, total: 0 }; 
        });
        mS.forEach(d => { 
            const v = d.data(); 
            if(s[v.pn]) s[v.pn].total += (v.tipo === 'entrada' ? v.qtd : -v.qtd); 
        });
        return s;
    }

    window.renderEstoque = async () => {
        const d = await getSaldos(); 
        const out = document.getElementById('tabEst'); 
        out.innerHTML = "";
        for(let k in d) {
            out.innerHTML += `<tr>
                <td><b>${k}</b></td>
                <td>${d[k].nome}</td>
                <td><span style="background:#f1f5f9; padding:4px 8px; border-radius:4px; font-size:12px;">${d[k].local || '-'}</span></td>
                <td><b style="color:${d[k].total <= d[k].min ? 'var(--danger)' : 'var(--text-main)'}">${d[k].total}</b></td>
            </tr>`;
        }
    };

    window.renderAlertas = async () => {
        const d = await getSaldos(); 
        const out = document.getElementById('aleCont'); 
        out.innerHTML = "";
        let temAlerta = false;
        for(let k in d) {
            if(d[k].total <= d[k].min) {
                temAlerta = true;
                out.innerHTML += `<div class="alerta-item">
                    <div><b>${d[k].nome}</b><br><small>PN: ${k}</small></div>
                    <div style="text-align:right">
                        <span style="color:var(--danger); font-weight:700">Cr√≠tico: ${d[k].total}</span><br>
                        <small>M√≠nimo: ${d[k].min}</small>
                    </div>
                </div>`;
            }
        }
        if(!temAlerta) out.innerHTML = "<p style='color:var(--success); text-align:center;'>‚úÖ Todos os itens est√£o com saldo ok.</p>";
    };

    let hCache = [];
    window.renderHistorico = async () => {
        const snap = await getDocs(query(collection(db, "movimentacoes"), orderBy("data", "desc")));
        hCache = []; 
        snap.forEach(d => hCache.push(d.data())); 
        filtrarHist();
    };

    window.filtrarHist = () => {
        const t = document.getElementById('fHist').value.toLowerCase(); 
        const out = document.getElementById('tabHis'); 
        out.innerHTML = "";
        hCache.filter(h => h.pn.toLowerCase().includes(t)).forEach(h => {
            const dt = h.data ? h.data.toDate().toLocaleString('pt-BR') : "...";
            const corTipo = h.tipo === 'entrada' ? 'var(--success)' : 'var(--danger)';
            out.innerHTML += `<tr>
                <td style="font-size:12px; color:var(--text-muted)">${dt}</td>
                <td><b>${h.pn}</b></td>
                <td><span style="color:${corTipo}; font-weight:bold; text-transform:uppercase; font-size:11px;">${h.tipo}</span></td>
                <td>${h.qtd}</td>
                <td style="font-size:12px;">${h.responsavel.split('@')[0]}</td>
            </tr>`;
        });
    };
</script>
</body>
</html>
