<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Panorama | Estoque</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<header>
    <div class="logo-area"><h1>PANORAMA HEALTH</h1></div>
    <div id="userInfo" style="font-size: 0.75rem; color: #64748B;">Operador: ...</div>
    <button onclick="window.location.href='painel.html'" style="background:none; border:none; color:var(--primary); font-weight:700; cursor:pointer">VOLTAR</button>
</header>

<div style="padding: 1rem; max-width: 1100px; margin: auto;">
    <div class="tabs">
        <button onclick="aba(event, 'cad')" class="active">CADASTRO</button>
        <button onclick="aba(event, 'mov')">MOVIMENTAÇÃO</button>
        <button onclick="aba(event, 'est')">ESTOQUE</button>
        <button onclick="aba(event, 'his')">HISTÓRICO</button>
        <button onclick="aba(event, 'ale')">ALERTAS</button>
    </div>

    <div id="cad" class="section active">
        <div class="grid-form">
            <div class="input-group"><label>Part Number</label><input type="text" id="pn"></div>
            <div class="input-group"><label>Nome do Item</label><input type="text" id="name"></div>
            <div class="input-group"><label>Nº Série (Fixo)</label><input type="text" id="sn"></div>
            <div class="input-group"><label>Estoque Mínimo</label><input type="number" id="min" value="5"></div>
        </div>
        <button class="btn-primary" onclick="cadastrar()">SALVAR ITEM</button>
    </div>

    <div id="mov" class="section">
        <div class="grid-form">
            <div class="input-group">
                <label>Buscar por Part Number</label>
                <input list="listPN" id="mPN" onchange="syncBusca(this.value, 'pn')" placeholder="Digite o PN...">
                <datalist id="listPN"></datalist>
            </div>
            <div class="input-group">
                <label>Buscar por Nome</label>
                <input list="listName" id="mName" onchange="syncBusca(this.value, 'name')" placeholder="Digite o Nome...">
                <datalist id="listName"></datalist>
            </div>
            <div class="input-group"><label>Quantidade</label><input type="number" id="mQtd"></div>
            <div class="input-group"><label>Nº Série desta unidade</label><input type="text" id="mSN"></div>
            <div class="input-group">
                <label>Tipo</label>
                <select id="mTipo">
                    <option value="entrada">ENTRADA (+)</option>
                    <option value="saida">SAÍDA (-)</option>
                </select>
            </div>
        </div>
        <button class="btn-primary" onclick="movimentar()">REGISTRAR OPERAÇÃO</button>
    </div>

    <div id="est" class="section">
        <div class="table-container">
            <table>
                <thead><tr><th>Part Number</th><th>Nome do Item</th><th>Saldo Atual</th></tr></thead>
                <tbody id="tabEst"></tbody>
            </table>
        </div>
    </div>

    <div id="his" class="section">
        <div class="filtros-hist">
            <input type="text" id="fHist" placeholder="Filtrar por PN ou Nome..." onkeyup="filtrarHistorico()">
        </div>
        <div class="table-container" style="margin-top:10px">
            <table>
                <thead><tr><th>Data</th><th>Item (PN)</th><th>Tipo</th><th>Qtd</th><th>Operador</th></tr></thead>
                <tbody id="tabHis"></tbody>
            </table>
        </div>
    </div>

    <div id="ale" class="section">
        <div id="alertasContainer"></div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyDvmATRrkhu-rJFpr2Ql_gYhIBK7sqdssQ",
    authDomain: "sistema-newenergy-panora-24697.firebaseapp.com",
    projectId: "sistema-newenergy-panora-24697",
    storageBucket: "sistema-newenergy-panora-24697.firebasestorage.app",
    messagingSenderId: "503251309234",
    appId: "1:503251309234:web:8f4d905e5e4b1f496befab"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let userEmail = "";
let dbProdutos = [];

onAuthStateChanged(auth, user => {
    if (user) {
        userEmail = user.email;
        document.getElementById('userInfo').innerText = "Operador: " + user.email;
        carregarDadosBase();
    } else { window.location.href = "login.html"; }
});

// SINCRONIZAR BUSCA (Se escolher PN, preenche Nome e vice-versa)
window.syncBusca = (val, tipo) => {
    const item = dbProdutos.find(p => tipo === 'pn' ? p.pn === val : p.name === val);
    if(item) {
        document.getElementById('mPN').value = item.pn;
        document.getElementById('mName').value = item.name;
    }
};

window.aba = (evt, name) => {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.tabs button').forEach(b => b.classList.remove('active'));
    document.getElementById(name).classList.add('active');
    evt.currentTarget.classList.add('active');
    if(name === 'est') renderEstoque();
    if(name === 'his') renderHistorico();
    if(name === 'ale') renderAlertas();
};

async function carregarDadosBase() {
    const snap = await getDocs(collection(db, "produtos"));
    dbProdutos = [];
    const dPN = document.getElementById('listPN');
    const dName = document.getElementById('listName');
    dPN.innerHTML = ""; dName.innerHTML = "";
    
    snap.forEach(doc => {
        const d = doc.data();
        dbProdutos.push(d);
        dPN.innerHTML += `<option value="${d.pn}">`;
        dName.innerHTML += `<option value="${d.name}">`;
    });
}

window.cadastrar = async () => {
    const pn = document.getElementById('pn').value;
    const name = document.getElementById('name').value;
    if(!pn || !name) return alert("PN e Nome são obrigatórios!");
    await addDoc(collection(db, "produtos"), {
        pn, name, sn: document.getElementById('sn').value,
        min: parseInt(document.getElementById('min').value) || 0,
        responsavel: userEmail, data: serverTimestamp()
    });
    alert("Item Cadastrado!"); location.reload();
};

window.movimentar = async () => {
    const pn = document.getElementById('mPN').value;
    const qtd = parseInt(document.getElementById('mQtd').value);
    if(!pn || !qtd) return alert("Selecione o item e a quantidade!");
    await addDoc(collection(db, "movimentacoes"), {
        pn, qtd, sn: document.getElementById('mSN').value,
        tipo: document.getElementById('mTipo').value,
        responsavel: userEmail, data: serverTimestamp()
    });
    alert("Operação realizada!"); 
    document.getElementById('mPN').value = "";
    document.getElementById('mName').value = "";
    document.getElementById('mQtd').value = "";
};

async function processarSaldos() {
    const pSnap = await getDocs(collection(db, "produtos"));
    const mSnap = await getDocs(collection(db, "movimentacoes"));
    let saldos = {};
    pSnap.forEach(doc => {
        const d = doc.data();
        saldos[d.pn] = { nome: d.name, min: d.min, total: 0 };
    });
    mSnap.forEach(doc => {
        const d = doc.data();
        if(saldos[d.pn]) saldos[d.pn].total += (d.tipo === 'entrada' ? d.qtd : -d.qtd);
    });
    return saldos;
}

window.renderEstoque = async () => {
    const dados = await processarSaldos();
    const out = document.getElementById('tabEst');
    out.innerHTML = "";
    for(let pn in dados) {
        out.innerHTML += `<tr><td><b>${pn}</b></td><td>${dados[pn].nome}</td><td>${dados[pn].total}</td></tr>`;
    }
};

window.renderAlertas = async () => {
    const dados = await processarSaldos();
    const out = document.getElementById('alertasContainer');
    out.innerHTML = "";
    let cont = 0;
    for(let pn in dados) {
        if(dados[pn].total <= dados[pn].min) {
            cont++;
            out.innerHTML += `
                <div class="alerta-card">
                    <div class="alerta-info">
                        <b>${dados[pn].nome} (${pn})</b>
                        <span>Quantidade mínima configurada: ${dados[pn].min}</span>
                    </div>
                    <div class="alerta-status">ATUAL: ${dados[pn].total}</div>
                </div>`;
        }
    }
    if(cont === 0) out.innerHTML = "<p style='text-align:center; color:green'>✅ Todos os itens acima do estoque mínimo.</p>";
};

let historicoLocal = [];
window.renderHistorico = async () => {
    const q = query(collection(db, "movimentacoes"), orderBy("data", "desc"));
    const snap = await getDocs(q);
    historicoLocal = [];
    snap.forEach(doc => historicoLocal.push(doc.data()));
    filtrarHistorico();
};

window.filtrarHistorico = () => {
    const termo = document.getElementById('fHist').value.toLowerCase();
    const out = document.getElementById('tabHis');
    out.innerHTML = "";
    historicoLocal.filter(h => h.pn.toLowerCase().includes(termo)).forEach(h => {
        const dt = h.data ? h.data.toDate().toLocaleString() : "...";
        out.innerHTML += `<tr><td>${dt}</td><td>${h.pn}</td><td style="color:${h.tipo==='entrada'?'green':'red'}">${h.tipo.toUpperCase()}</td><td>${h.qtd}</td><td>${h.responsavel}</td></tr>`;
    });
};
</script>
</body>
</html>
