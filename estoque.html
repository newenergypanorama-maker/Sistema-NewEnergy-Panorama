<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Estoque Dinâmico - NewEnergy Panorama Health</title>
<link rel="stylesheet" href="style.css">
</head>

<body>

<header>
  <img src="logo.png" class="logo">
  <h1>Controle Avançado de Estoque</h1>
</header>

<div class="main">
<div class="container">

<h2>Cadastro de Produto</h2>

<input type="text" id="partNumber" placeholder="Part Number">
<input type="text" id="partName" placeholder="Part Name">
<input type="number" id="quantity" placeholder="Quantidade">
<input type="text" id="client" placeholder="Cliente">
<select id="type">
  <option value="entrada">Entrada</option>
  <option value="saida">Saída</option>
</select>

<button class="primary" onclick="registrarMovimentacao()">Registrar Movimentação</button>

<hr style="margin:30px 0">

<h2>Filtros</h2>

<input type="text" id="filtroPN" placeholder="Filtrar por Part Number">
<input type="text" id="filtroCliente" placeholder="Filtrar por Cliente">
<button class="primary" onclick="carregarMovimentacoes()">Aplicar Filtros</button>

<hr style="margin:30px 0">

<h2>Histórico de Movimentações</h2>

<table id="tabela">
<thead>
<tr>
<th>Data/Hora</th>
<th>Part Number</th>
<th>Part Name</th>
<th>Tipo</th>
<th>Quantidade</th>
<th>Cliente</th>
<th>Saldo Atual</th>
</tr>
</thead>
<tbody></tbody>
</table>

<button class="primary" onclick="window.location.href='painel.html'">
Voltar ao Painel
</button>

</div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDvmATRrkhu-rJFpr2Ql_gYhIBK7sqdssQ",
  authDomain: "sistema-newenergy-panora-24697.firebaseapp.com",
  projectId: "sistema-newenergy-panora-24697",
  storageBucket: "sistema-newenergy-panora-24697.firebasestorage.app",
  messagingSenderId: "503251309234",
  appId: "1:503251309234:web:8f4d905e5e4b1f496befab"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

onAuthStateChanged(auth, user => {
  if (!user) window.location.href = "login.html";
});

window.registrarMovimentacao = async function() {

  const pn = document.getElementById("partNumber").value;
  const name = document.getElementById("partName").value;
  const qty = parseInt(document.getElementById("quantity").value);
  const client = document.getElementById("client").value;
  const type = document.getElementById("type").value;

  if(!pn || !name || !qty){
    alert("Preencha todos os campos obrigatórios.");
    return;
  }

  let saldoAtual = 0;

  const snapshot = await getDocs(collection(db, "movimentacoes"));

  snapshot.forEach(doc => {
    const data = doc.data();
    if(data.partNumber === pn){
      if(data.type === "entrada") saldoAtual += data.quantity;
      if(data.type === "saida") saldoAtual -= data.quantity;
    }
  });

  if(type === "saida" && qty > saldoAtual){
    alert("Estoque insuficiente!");
    return;
  }

  const novoSaldo = type === "entrada" ? saldoAtual + qty : saldoAtual - qty;

  await addDoc(collection(db, "movimentacoes"), {
    partNumber: pn,
    partName: name,
    quantity: qty,
    client: client,
    type: type,
    saldo: novoSaldo,
    createdAt: serverTimestamp()
  });

  alert("Movimentação registrada com sucesso!");
  carregarMovimentacoes();
}

window.carregarMovimentacoes = async function(){

  const filtroPN = document.getElementById("filtroPN").value;
  const filtroCliente = document.getElementById("filtroCliente").value;

  const tabela = document.querySelector("#tabela tbody");
  tabela.innerHTML = "";

  const q = query(collection(db, "movimentacoes"), orderBy("createdAt", "desc"));
  const snapshot = await getDocs(q);

  snapshot.forEach(doc => {

    const data = doc.data();

    if(filtroPN && !data.partNumber.includes(filtroPN)) return;
    if(filtroCliente && !data.client.includes(filtroCliente)) return;

    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${data.createdAt?.toDate().toLocaleString() || ""}</td>
      <td>${data.partNumber}</td>
      <td>${data.partName}</td>
      <td>${data.type}</td>
      <td>${data.quantity}</td>
      <td>${data.client}</td>
      <td>${data.saldo}</td>
    `;

    tabela.appendChild(tr);
  });

}

carregarMovimentacoes();

</script>

</body>
</html>
