<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Gestão de Estoque - NewEnergy</title>
<link rel="stylesheet" href="style.css">

<style>
.menu-interno{
  display:flex;
  gap:10px;
  margin-bottom:20px;
  flex-wrap:wrap;
}
.menu-interno button{
  flex:1;
}
.section{
  display:none;
}
.section.active{
  display:block;
}
.alerta{
  background:#FEE2E2;
  padding:10px;
  border-radius:6px;
  margin-bottom:10px;
  color:#991B1B;
}
</style>

</head>

<body>

<header>
  <img src="logo.png" class="logo">
  <h1>Gestão Profissional de Estoque</h1>
</header>

<div class="main">
<div class="container">

<div class="menu-interno">
  <button class="primary" onclick="mostrar('cadastro')">Cadastro Produto</button>
  <button class="primary" onclick="mostrar('movimentacao')">Movimentação</button>
  <button class="primary" onclick="mostrar('atual')">Estoque Atual</button>
  <button class="primary" onclick="mostrar('minimo')">Estoque Mínimo</button>
</div>

<!-- CADASTRO PRODUTO -->
<div id="cadastro" class="section active">
<h2>Cadastrar Produto</h2>
<input type="text" id="pn" placeholder="Part Number">
<input type="text" id="name" placeholder="Part Name">
<input type="number" id="min" placeholder="Estoque Mínimo">
<button class="primary" onclick="cadastrarProduto()">Salvar Produto</button>
</div>

<!-- MOVIMENTAÇÃO -->
<div id="movimentacao" class="section">
<h2>Entrada / Saída</h2>
<input type="text" id="movPN" placeholder="Part Number">
<input type="number" id="movQtd" placeholder="Quantidade">
<input type="text" id="cliente" placeholder="Cliente">
<select id="tipo">
<option value="entrada">Entrada</option>
<option value="saida">Saída</option>
</select>
<button class="primary" onclick="registrarMov()">Registrar</button>
</div>

<!-- ESTOQUE ATUAL -->
<div id="atual" class="section">
<h2>Estoque Atual</h2>
<table id="tabelaAtual">
<thead>
<tr>
<th>Part Number</th>
<th>Part Name</th>
<th>Saldo</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<!-- ESTOQUE MÍNIMO -->
<div id="minimo" class="section">
<h2>Produtos Abaixo do Mínimo</h2>
<div id="alertas"></div>
</div>

<button class="primary" onclick="window.location.href='painel.html'">
Voltar ao Painel
</button>

</div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDvmATRrkhu-rJFpr2Ql_gYhIBK7sqdssQ",
  authDomain: "sistema-newenergy-panora-24697.firebaseapp.com",
  projectId: "sistema-newenergy-panora-24697",
  storageBucket: "sistema-newenergy-panora-24697.firebasestorage.app",
  messagingSenderId: "503251309234",
  appId: "1:503251309234:web:8f4d905e5e4b1f496befab"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

onAuthStateChanged(auth, user=>{
 if(!user) window.location.href="login.html";
});

window.mostrar = function(sec){
 document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
 document.getElementById(sec).classList.add('active');
 if(sec==="atual") carregarEstoque();
 if(sec==="minimo") verificarMinimo();
}

window.cadastrarProduto = async function(){
 const pn=document.getElementById("pn").value;
 const name=document.getElementById("name").value;
 const min=parseInt(document.getElementById("min").value);

 if(!pn||!name||!min){ alert("Preencha todos os campos"); return; }

 await addDoc(collection(db,"produtos"),{
  partNumber:pn,
  partName:name,
  estoqueMinimo:min,
  createdAt:serverTimestamp()
 });

 alert("Produto cadastrado!");
}

window.registrarMov = async function(){
 const pn=document.getElementById("movPN").value;
 const qtd=parseInt(document.getElementById("movQtd").value);
 const cliente=document.getElementById("cliente").value;
 const tipo=document.getElementById("tipo").value;

 let saldo=0;

 const snap=await getDocs(collection(db,"movimentacoes"));
 snap.forEach(doc=>{
  const d=doc.data();
  if(d.partNumber===pn){
   if(d.tipo==="entrada") saldo+=d.quantidade;
   if(d.tipo==="saida") saldo-=d.quantidade;
  }
 });

 if(tipo==="saida" && qtd>saldo){
  alert("Saldo insuficiente");
  return;
 }

 const novoSaldo = tipo==="entrada"? saldo+qtd: saldo-qtd;

 await addDoc(collection(db,"movimentacoes"),{
  partNumber:pn,
  quantidade:qtd,
  cliente:cliente,
  tipo:tipo,
  saldo:novoSaldo,
  createdAt:serverTimestamp()
 });

 alert("Movimentação registrada");
}

async function carregarEstoque(){
 const tabela=document.querySelector("#tabelaAtual tbody");
 tabela.innerHTML="";
 const snap=await getDocs(collection(db,"movimentacoes"));

 const mapa={};

 snap.forEach(doc=>{
  const d=doc.data();
  if(!mapa[d.partNumber]) mapa[d.partNumber]=0;
  if(d.tipo==="entrada") mapa[d.partNumber]+=d.quantidade;
  if(d.tipo==="saida") mapa[d.partNumber]-=d.quantidade;
 });

 for(const pn in mapa){
  const tr=document.createElement("tr");
  tr.innerHTML=`<td>${pn}</td><td>-</td><td>${mapa[pn]}</td>`;
  tabela.appendChild(tr);
 }
}

async function verificarMinimo(){
 const div=document.getElementById("alertas");
 div.innerHTML="";
 const produtos=await getDocs(collection(db,"produtos"));
 const mov=await getDocs(collection(db,"movimentacoes"));

 const saldo={};

 mov.forEach(doc=>{
  const d=doc.data();
  if(!saldo[d.partNumber]) saldo[d.partNumber]=0;
  if(d.tipo==="entrada") saldo[d.partNumber]+=d.quantidade;
  if(d.tipo==="saida") saldo[d.partNumber]-=d.quantidade;
 });

 produtos.forEach(doc=>{
  const p=doc.data();
  const atual=saldo[p.partNumber]||0;
  if(atual<=p.estoqueMinimo){
   const alerta=document.createElement("div");
   alerta.className="alerta";
   alerta.innerHTML=`${p.partName} (${p.partNumber}) está abaixo do mínimo. Saldo: ${atual}`;
   div.appendChild(alerta);
  }
 });
}

</script>

</body>
</html>
